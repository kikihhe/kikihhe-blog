---
title: 用户态和内核态
date: 2023-08-02 01:05:40
permalink: /pages/c6965c/
---

## 1. 什么是用户态和内核态
根据进程访问资源的特点，可以**把进程在系统的运行分为两个级别** ：用户态、内核态。

1. 用户态（User Mode） ：用户态级进程可以直接读取用户程序的数据，拥有较低的权限。

   当应用程序需要执行某些特殊权限的操作，例如读写磁盘、网络通信等，就需要向操作系统发起系统调用请求，并进入内核态。
2. 内核态（Kernel Mode）：内核态运行的进程几乎可以访问计算机的任何资源，包括系统的内存空间、设备、驱动程序等，不受限制，拥有非常高的权限。

   当操作系统接收到进程的系统调用请求时，就会从用户态切换到内核态，执行相应的系统调用，并将结果返回给进程，最后再从内核态切换回用户态。

什么时候会发起系统调用？应用程序想要访问系统资源时，例如读写文件、分配内存....

再次强调，我们平时运行的应用程序是在用户空间中的，只有当出现*内存分配*、*文件操作*等操作时
才会切换为内核空间，并且<font color=Green>用户空间是无法访问这些资源的，用户进程想要访问系统资源就必须要 进行系统调用从用户空间切换到内核空间。</font>


![](https://typorehwf.oss-cn-chengdu.aliyuncs.com/20230802013112.png)

内核态相比于用户态拥有更高的权限，因此能够执行更底层、更敏感的操作。不过，由于进入内核态需要付出较高的开销（一系列上下文切换和权限检查），应该<font color=Green>尽量减少用户态与内核态切换的次数以提高系统的性能和稳定性。</font>

**用户态和内核态之间如何切换 ？**

有三种方式可以将用户态切换为内核态 ：系统调用、中断、异常。

1. **系统调用** ：用户态主动要求切换为内核态，主要是为了使用内核态才能做的事。系统调用的机制核心还是使用了操作系统为用户特别开放的一个中断来实现。
2. **中断** ：当外围设备完成用户请求的操作后，会向CPU发出相应的中断信号，这时CPU会暂停执行下一条指令而去执行与中断信号对应的处理程序。

   *如果先前执行的指令是用户态下的程序*并且*中断信号对应的处理程序是内核态*，那么这个转换的过程自然也就发生了用户态到内核态的切换。比如硬盘读写操作完成，系统会切换到硬盘读写的中断处理程序中执行后续逻辑。
3. **异常** ：当CPU在执行用户态下的程序时，发生了异常，这时会触发由当前运行进程切换到处理此异常的内核相关程序中，也就转到了内核态，比如缺页异常。


## 2. 为什么要区分用户态和内核态
1. 在CPU的所有指令中，有一些执行是比较危险的，比如内存分配、设置时钟、文件IO处理 等，如果所有程序都能使用这些指令，会对系统的正常运行造成灾难性的影响。因此，我们需要限制这些危险指令只能在内核态运行。这些只能由操作系统内核态执行的指令也被叫做特权指令。
2. 如果计算机中只有一个内核态，那么所有程序或进程都必须共享系统资源，例如内存、CPU、硬盘等，这将导致系统资源的竞争和冲突，从而影响系统性能和效率。并且，这样也会让系统的安全性降低，毕竟所有程序或进程都有相同的特权级别和访问权限。

因此，同时具有用户态和内核态主要是为了计算机系统的安全性、稳定性和性能。

## 3. 什么是系统调用
刚才一直在说“只有经过系统调用，进程才会从用户态切换为内核态”，那么什么是系统调用呢？常用的又有哪些系统调用呢？

系统调用大致可以分为以下几类：

1. 设备管理 ：完成设备（输入输出设备和外部存储设备）的请求或释放、设备启动等。
2. 文件管理 ：文件的读写、创建、删除
3. 进程管理 ：进程的创建、撤销、阻塞、唤醒、进程之间的通信
4. 内存管理 ：内存和分配、回收、获取内存地址等。

系统调用是应用程序与操作系统之间进行交互的一种方式，通过系统调用，应用程序可以访问操作系统底层资源，如文件、设备、网络等。

系统调用的过程 ：

1. 用户态发起系统调用，因为系统调用中涉及一些特权指令（只能由操作系统内核态执行的指令），用户态程序权限不足，因此会中断执行，也就是 Trap（Trap是一种中断）
2. 发生中断后，当前CPU执行的程序会中断，跳转到中断处理程序。内核程序开始执行，也就是开始处理系统调用。
3. 内核处理完成后，主动触发 Trap，这样会再次发生中断，切换回用户态。

常用的系统调用：文件操作，例如read、write